---
import autumnSchemeUrl from '../../styles/schemes/autumn.css?url';
import avocadoSchemeUrl from '../../styles/schemes/avocado.css?url';
import bloodySchemeUrl from '../../styles/schemes/bloody.css?url';
import blowfishSchemeUrl from '../../styles/schemes/blowfish.css?url';
import congoSchemeUrl from '../../styles/schemes/congo.css?url';
import fireSchemeUrl from '../../styles/schemes/fire.css?url';
import forestSchemeUrl from '../../styles/schemes/forest.css?url';
import githubSchemeUrl from '../../styles/schemes/github.css?url';
import marvelSchemeUrl from '../../styles/schemes/marvel.css?url';
import neonSchemeUrl from '../../styles/schemes/neon.css?url';
import noirSchemeUrl from '../../styles/schemes/noir.css?url';
import oceanSchemeUrl from '../../styles/schemes/ocean.css?url';
import oneLightSchemeUrl from '../../styles/schemes/one-light.css?url';
import princessSchemeUrl from '../../styles/schemes/princess.css?url';
import slateSchemeUrl from '../../styles/schemes/slate.css?url';
import terminalSchemeUrl from '../../styles/schemes/terminal.css?url';

export interface AuthorLink {
  name: string;
  url: string;
}

export interface Verification {
  google?: string;
  bing?: string;
  pinterest?: string;
  yandex?: string;
  fediverse?: string;
}

export interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  image?: string;
  noindex?: boolean;
  siteTitle?: string;
  isHome?: boolean;
  keywords?: string[];
  authorName?: string;
  authorLinks?: AuthorLink[];
  verification?: Verification;
  colorScheme?: string;
  languageCode?: string;
  locale?: string;
  robots?: string;
  publishedTime?: string;
  defaultSocialImage?: string;
  ogType?: 'website' | 'article';
  alternativeOutputFormats?: Array<{
    rel: string;
    type: string;
    href: string;
    title?: string;
  }>;
}

const {
  title,
  description = '',
  canonicalUrl,
  image,
  noindex = false,
  siteTitle = 'Blowfish Astro Theme',
  isHome = false,
  keywords = [],
  authorName,
  authorLinks = [],
  verification,
  colorScheme = 'blowfish',
  languageCode = 'en',
  locale = 'en_US',
  robots,
  publishedTime,
  defaultSocialImage,
  ogType = 'website',
  alternativeOutputFormats = [],
} = Astro.props;

const fullTitle = isHome ? siteTitle : `${title} Â· ${siteTitle}`;
const keywordContent = keywords.length > 0 ? `${keywords.join(',')},` : '';
const resolvedImage = image || defaultSocialImage;
const schemeUrlMap: Record<string, string> = {
  autumn: autumnSchemeUrl,
  avocado: avocadoSchemeUrl,
  bloody: bloodySchemeUrl,
  blowfish: blowfishSchemeUrl,
  congo: congoSchemeUrl,
  fire: fireSchemeUrl,
  forest: forestSchemeUrl,
  github: githubSchemeUrl,
  marvel: marvelSchemeUrl,
  neon: neonSchemeUrl,
  noir: noirSchemeUrl,
  ocean: oceanSchemeUrl,
  'one-light': oneLightSchemeUrl,
  princess: princessSchemeUrl,
  slate: slateSchemeUrl,
  terminal: terminalSchemeUrl,
};
const selectedSchemeUrl = schemeUrlMap[colorScheme.toLowerCase()] ?? blowfishSchemeUrl;
const themeScript = `(function(){
  var root = document.documentElement;
  var media = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;

  function getUserPreference() {
    return localStorage.getItem('appearance');
  }

  function applyAppearancePreference() {
    var sitePreference = root.getAttribute('data-default-appearance');
    var autoAppearance = root.getAttribute('data-auto-appearance') === 'true';
    var userPreference = getUserPreference();
    var isDark = false;

    if ((sitePreference === 'dark' && userPreference === null) || userPreference === 'dark') {
      isDark = true;
    }

    if (autoAppearance && media && media.matches && userPreference !== 'light') {
      isDark = true;
    }

    if (autoAppearance && media && !media.matches && userPreference !== 'dark' && userPreference !== 'light') {
      isDark = sitePreference === 'dark';
    }

    if (isDark) {
      root.classList.add('dark');
    } else {
      root.classList.remove('dark');
    }
  }

  applyAppearancePreference();

  if (root.getAttribute('data-auto-appearance') === 'true' && media) {
    media.addEventListener('change', function() {
      applyAppearancePreference();
      window.updateMeta?.();
      window.updateMermaidTheme?.();
      window.updateLogo?.(window.getTargetAppearance?.());
    });
  }

  window.updateMeta = function () {
    var body = document.querySelector('body');
    if (!body) return;
    var style = getComputedStyle(body);
    var meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', style.backgroundColor);
  };

  window.getTargetAppearance = function () {
    return root.classList.contains('dark') ? 'dark' : 'light';
  };

  window.updateLogo = function (targetAppearance) {
    var lightLogo = root.getAttribute('data-logo-light');
    var darkLogo = root.getAttribute('data-logo-dark');
    if (!lightLogo || !darkLogo) return;
    var targetLogo = targetAppearance === 'dark' ? darkLogo : lightLogo;
    document.querySelectorAll('img.logo').forEach(function (img) {
      img.setAttribute('src', targetLogo);
    });
  };

  window.applyAppearancePreference = applyAppearancePreference;
})();`;
---

<meta charset="utf-8" />
<meta http-equiv="content-language" content={languageCode} />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<meta name="theme-color" />
<title>{fullTitle}</title>
<meta name="title" content={fullTitle} />
{description && <meta name="description" content={description} />}
{keywordContent && <meta name="keywords" content={keywordContent} />}
{(robots || noindex) && <meta name="robots" content={noindex ? 'noindex,nofollow' : robots} />}
{canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
{authorName && <meta name="author" content={authorName} />}
{authorLinks
  .filter((link) => !link.url.startsWith('mailto:'))
  .map((link) => <link href={link.url} rel="me" />)}

<meta property="og:type" content={ogType} />
<meta property="og:title" content={fullTitle} />
<meta property="og:site_name" content={siteTitle} />
<meta property="og:locale" content={locale} />
{description && <meta property="og:description" content={description} />}
{canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
{resolvedImage && <meta property="og:image" content={resolvedImage} />}
{publishedTime && <meta property="article:published_time" content={publishedTime} />}

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={fullTitle} />
{description && <meta name="twitter:description" content={description} />}
{resolvedImage && <meta name="twitter:image" content={resolvedImage} />}

{verification?.google && <meta name="google-site-verification" content={verification.google} />}
{verification?.bing && <meta name="msvalidate.01" content={verification.bing} />}
{verification?.pinterest && <meta name="p:domain_verify" content={verification.pinterest} />}
{verification?.yandex && <meta name="yandex-verification" content={verification.yandex} />}
{verification?.fediverse && <meta name="fediverse:creator" content={verification.fediverse} />}

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
<link rel="manifest" href="/site.webmanifest" />
<link rel="stylesheet" href={selectedSchemeUrl} />
{alternativeOutputFormats.map((format) => (
  <link rel={format.rel} type={format.type} href={format.href} title={format.title || siteTitle} />
))}

<script is:inline set:html={themeScript}></script>
<script is:inline>
  window.addEventListener('DOMContentLoaded', function () {
    const switcher = document.getElementById('appearance-switcher');
    const switcherMobile = document.getElementById('appearance-switcher-mobile');

    const toggleAppearance = () => {
      document.documentElement.classList.toggle('dark');
      const targetAppearance = window.getTargetAppearance();
      localStorage.setItem('appearance', targetAppearance);
      window.updateMeta?.();
      window.updateMermaidTheme?.();
      window.updateLogo?.(targetAppearance);
    };

    switcher?.addEventListener('click', toggleAppearance);
    switcherMobile?.addEventListener('click', toggleAppearance);

    switcher?.addEventListener('contextmenu', (event) => {
      event.preventDefault();
      localStorage.removeItem('appearance');
      window.applyAppearancePreference?.();
      window.updateMeta?.();
      window.updateMermaidTheme?.();
      window.updateLogo?.(window.getTargetAppearance?.());
    });

    switcherMobile?.addEventListener('contextmenu', (event) => {
      event.preventDefault();
      localStorage.removeItem('appearance');
      window.applyAppearancePreference?.();
      window.updateMeta?.();
      window.updateMermaidTheme?.();
      window.updateLogo?.(window.getTargetAppearance?.());
    });

    window.updateMeta?.();
    window.updateLogo?.(window.getTargetAppearance?.());
  });
</script>
