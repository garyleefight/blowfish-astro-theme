---
import BlowfishIcon from '../BlowfishIcon.astro';
import { t } from '../../lib/i18n';
---

<div
  id="search-wrapper"
  class="invisible fixed inset-0 z-[500] flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="/"
>
  <div
    id="search-modal"
    class="top-20 mx-auto flex min-h-0 w-full max-w-3xl flex-col rounded-md border border-neutral-200 bg-neutral shadow-lg dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex flex-none items-center justify-between px-2">
      <form class="flex min-w-0 flex-auto items-center" onsubmit="return false;">
        <div class="flex h-8 w-8 items-center justify-center text-neutral-400">
          <BlowfishIcon name="search" />
        </div>
        <input
          type="search"
          id="search-query"
          class="mx-1 flex h-12 flex-auto appearance-none bg-transparent focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder={t('search.input_placeholder')}
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex h-8 w-8 items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title={t('search.close_button_title')}
      >
        <BlowfishIcon name="xmark" />
      </button>
    </header>
    <section class="flex-auto overflow-auto px-2">
      <ul id="search-results"></ul>
    </section>
  </div>
</div>

<script is:inline src="/blowfish-lib/fuse/fuse.min.js"></script>
<script is:inline>
  let fuse;
  const showButton = document.getElementById('search-button');
  const showButtonMobile = document.getElementById('search-button-mobile');
  const hideButton = document.getElementById('close-search-button');
  const wrapper = document.getElementById('search-wrapper');
  const modal = document.getElementById('search-modal');
  const input = document.getElementById('search-query');
  const output = document.getElementById('search-results');
  let first = output?.firstChild;
  let last = output?.lastChild;
  let searchVisible = false;
  let indexed = false;
  let hasResults = false;

  function fetchJSON(path, callback) {
    const httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function () {
      if (httpRequest.readyState === 4 && httpRequest.status === 200) {
        callback(JSON.parse(httpRequest.responseText));
      }
    };
    httpRequest.open('GET', path);
    httpRequest.send();
  }

  function buildIndex() {
    const baseURL = '/';
    fetchJSON(baseURL + 'index.json', function (data) {
      const options = {
        shouldSort: true,
        ignoreLocation: true,
        threshold: 0.0,
        includeMatches: true,
        keys: [
          { name: 'title', weight: 0.8 },
          { name: 'section', weight: 0.2 },
          { name: 'summary', weight: 0.6 },
          { name: 'content', weight: 0.4 },
        ],
      };
      fuse = new Fuse(data, options);
      indexed = true;
    });
  }

  function executeQuery(term) {
    if (!fuse || !output) return;
    const results = fuse.search(term);
    let resultsHTML = '';

    if (results.length > 0) {
      results.forEach((value) => {
        const title = value.item.externalUrl
          ? value.item.title +
            '<span class="text-xs ml-2 align-center cursor-default text-neutral-400 dark:text-neutral-500">' +
            value.item.externalUrl +
            '</span>'
          : value.item.title;

        const linkconfig = value.item.externalUrl
          ? 'target="_blank" rel="noopener" href="' + value.item.externalUrl + '"'
          : 'href="' + value.item.permalink + '"';

        resultsHTML += `<li class="mb-2">
          <a class="flex items-center rounded-md bg-neutral-100 px-3 py-2 appearance-none hover:bg-primary-100 focus:bg-primary-100 focus:outline-dotted focus:outline-2 focus:outline-transparent dark:bg-neutral-700 dark:hover:bg-primary-900 dark:focus:bg-primary-900" ${linkconfig} tabindex="0">
            <div class="grow">
              <div class="-mb-1 text-lg font-bold">${title}</div>
              <div class="text-sm text-neutral-500 dark:text-neutral-400">${value.item.section}<span class="px-2 text-primary-500">&middot;</span>${value.item.date || ''}</div>
              <div class="text-sm italic">${value.item.summary || ''}</div>
            </div>
            <div class="ml-2 ltr:block rtl:hidden text-neutral-500">&rarr;</div>
            <div class="mr-2 ltr:hidden rtl:block text-neutral-500">&larr;</div>
          </a>
        </li>`;
      });
      hasResults = true;
    } else {
      hasResults = false;
    }

    output.innerHTML = resultsHTML;
    if (results.length > 0) {
      first = output.firstChild?.firstElementChild;
      last = output.lastChild?.firstElementChild;
    }
  }

  function displaySearch() {
    if (!wrapper || !input) return;
    if (!indexed) {
      buildIndex();
    }
    if (!searchVisible) {
      document.body.style.overflow = 'hidden';
      wrapper.style.visibility = 'visible';
      input.focus();
      searchVisible = true;
    }
  }

  function hideSearch() {
    if (!wrapper || !input || !output) return;
    if (searchVisible) {
      document.body.style.overflow = 'visible';
      wrapper.style.visibility = 'hidden';
      input.value = '';
      output.innerHTML = '';
      document.activeElement?.blur?.();
      searchVisible = false;
    }
  }

  window.displaySearch = displaySearch;
  window.hideSearch = hideSearch;

  showButton?.addEventListener('click', displaySearch);
  showButtonMobile?.addEventListener('click', displaySearch);
  hideButton?.addEventListener('click', hideSearch);

  wrapper?.addEventListener('click', hideSearch);
  modal?.addEventListener('click', function (event) {
    event.stopPropagation();
    event.stopImmediatePropagation();
    return false;
  });

  document.addEventListener('keydown', function (event) {
    if (event.key === '/') {
      const active = document.activeElement;
      const tag = active?.tagName;
      const isInputField = tag === 'INPUT' || tag === 'TEXTAREA' || active?.isContentEditable;
      if (!searchVisible && !isInputField) {
        event.preventDefault();
        displaySearch();
      }
    }

    if (event.key === 'Escape') {
      hideSearch();
    }

    if (event.key === 'ArrowDown' && searchVisible && hasResults) {
      event.preventDefault();
      if (document.activeElement === input) {
        first?.focus();
      } else if (document.activeElement === last) {
        last?.focus();
      } else {
        document.activeElement?.parentElement?.nextSibling?.firstElementChild?.focus();
      }
    }

    if (event.key === 'ArrowUp' && searchVisible && hasResults) {
      event.preventDefault();
      if (document.activeElement === input || document.activeElement === first) {
        input?.focus();
      } else {
        document.activeElement?.parentElement?.previousSibling?.firstElementChild?.focus();
      }
    }

    if (event.key === 'Enter' && searchVisible && hasResults) {
      event.preventDefault();
      if (document.activeElement === input) {
        first?.focus();
      } else {
        document.activeElement?.click?.();
      }
    }
  });

  if (input) {
    input.onkeyup = function () {
      executeQuery(input.value);
    };
  }
</script>
