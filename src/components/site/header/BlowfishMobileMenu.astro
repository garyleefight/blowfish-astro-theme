---
import BlowfishIcon from '../../BlowfishIcon.astro';
import BlowfishAppearanceToggle from '../BlowfishAppearanceToggle.astro';
import BlowfishA11y from './BlowfishA11y.astro';
import BlowfishTranslations, { type TranslationItem } from './BlowfishTranslations.astro';
import { t } from '../../../lib/i18n';

export interface MenuItem {
  name: string;
  url: string;
  title?: string;
  pre?: string;
  identifier?: string;
  children?: MenuItem[];
}

export interface Props {
  mainMenu?: MenuItem[];
  subnavMenu?: MenuItem[];
  translations?: TranslationItem[];
  currentLanguage?: string;
  enableA11y?: boolean;
  enableSearch?: boolean;
  enableAppearanceToggle?: boolean;
  showDisableBlurA11y?: boolean;
  showDisableImagesA11y?: boolean;
}

const {
  mainMenu = [],
  subnavMenu = [],
  translations = [],
  currentLanguage = t('global.language'),
  enableA11y = false,
  enableSearch = false,
  enableAppearanceToggle = false,
  showDisableBlurA11y = true,
  showDisableImagesA11y = true,
} = Astro.props;
const isExternal = (url: string) => url.startsWith('http:') || url.startsWith('https:');
const submenuId = (item: MenuItem, index: number) => `fullscreen-submenu-${(item.identifier || item.name || String(index)).toLowerCase().replace(/\s+/g, '-')}`;
---

<div class="flex items-center h-14 gap-4">
  {enableSearch && (
    <button id="search-button-mobile" aria-label={t('search.button_label')} class="flex items-center justify-center text-neutral-700 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400" title={t('search.open_button_title')}>
      <BlowfishIcon name="search" />
    </button>
  )}

  {enableAppearanceToggle && <BlowfishAppearanceToggle id="appearance-switcher-mobile" />}

  {(mainMenu.length > 0 || subnavMenu.length > 0 || translations.length > 0 || enableA11y) && (
    <>
      <input type="checkbox" id="mobile-menu-toggle" autocomplete="off" class="hidden peer" />
      <label for="mobile-menu-toggle" class="flex items-center justify-center cursor-pointer text-neutral-700 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400">
        <BlowfishIcon name="bars" />
      </label>

      <div
        role="dialog"
        aria-modal="true"
        style="scrollbar-gutter: stable;"
        class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99 bf-scrollbar"
      >
        <label
          for="mobile-menu-toggle"
          class="fixed end-8 top-5 z-50 flex h-12 w-12 cursor-pointer select-none items-center justify-center rounded-full border border-neutral-300 bg-neutral-50 text-neutral-700 hover:border-primary-600 hover:text-primary-600 dark:border-neutral-700 dark:bg-neutral-900 dark:text-neutral-200 dark:hover:border-primary-400 dark:hover:text-primary-400"
        >
          <BlowfishIcon name="xmark" />
        </label>
        <nav class="mx-auto max-w-md space-y-6">
          {mainMenu.map((item, index) => {
            const id = submenuId(item, index);
            return (
              <div class="px-2">
                <a
                  href={item.url}
                  aria-label={item.name || item.pre}
                  target={isExternal(item.url) ? '_blank' : undefined}
                  class="group flex items-center gap-4 text-neutral-700 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"
                >
                  {item.pre && (
                    <span class="flex items-center justify-center h-8 w-8 text-2xl">
                      <BlowfishIcon name={item.pre} />
                    </span>
                  )}
                  <span title={item.title} class="text-2xl font-bold tracking-tight">{item.name}</span>
                  {item.children && item.children.length > 0 && (
                    <label
                      for={id}
                      class="ms-auto flex h-10 w-10 cursor-pointer items-center justify-center rounded-lg border border-neutral-300 text-neutral-700 hover:border-primary-600 hover:text-primary-600 dark:border-neutral-700 dark:text-neutral-200 dark:hover:border-primary-400 dark:hover:text-primary-400"
                    >
                      <BlowfishIcon name="chevron-down" />
                    </label>
                  )}
                </a>

                {item.children && item.children.length > 0 && (
                  <>
                    <input checked type="checkbox" id={id} autocomplete="off" class="hidden peer/full" />
                    <div class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 peer-checked/full:grid-rows-[1fr]">
                      <div class="overflow-hidden">
                        <div class="ms-7 mt-4">
                          {item.children.map((child) => (
                            <a
                              href={child.url}
                              aria-label={child.name || child.pre}
                              target={isExternal(child.url) ? '_blank' : undefined}
                              class="group flex items-center gap-3 p-2 text-neutral-700 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"
                            >
                              {child.pre && (
                                <span class="flex items-center justify-center h-5 w-5">
                                  <BlowfishIcon name={child.pre} />
                                </span>
                              )}
                              <span title={child.title} class="text-lg">{child.name}</span>
                            </a>
                          ))}
                        </div>
                      </div>
                    </div>
                  </>
                )}
              </div>
            );
          })}

          {subnavMenu.length > 0 && (
            <div class="mt-8 flex flex-wrap gap-4 border-t border-neutral-300 pt-8 dark:border-neutral-700">
              {subnavMenu.map((item) => (
                <a href={item.url} aria-label={item.name || item.pre} class="inline-flex items-center gap-2 rounded-full px-2 py-2 text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400">
                  {item.pre && (
                    <span class="flex items-center justify-center h-4 w-4">
                      <BlowfishIcon name={item.pre} />
                    </span>
                  )}
                  <span title={item.title}>{item.name}</span>
                </a>
              ))}
            </div>
          )}

          {(translations.length > 0 || enableA11y) && (
            <div class="flex flex-wrap items-center gap-x-6 ps-2 mt-8 pt-8 border-t border-neutral-300 dark:border-neutral-700 [&_span]:text-2xl [&_.translation_button_.icon]:text-4xl [&_.translation_button_span]:text-base [&_.translation_.menuhide_span]:text-sm">
              <BlowfishTranslations translations={translations} currentLanguage={currentLanguage} />
              {enableA11y && (
                <BlowfishA11y
                  prefix="mobile-menu-"
                  showDisableBlur={showDisableBlurA11y}
                  showDisableImages={showDisableImagesA11y}
                />
              )}
            </div>
          )}
        </nav>
      </div>
    </>
  )}
</div>
