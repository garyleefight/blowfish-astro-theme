---
import { t } from '../../lib/i18n';
import BlowfishHomeRecent from './BlowfishHomeRecent.astro';
import type { BlowfishHomepageConfig, BlowfishRecentArticle } from '../../types/homepage';

export interface Props {
  config: BlowfishHomepageConfig;
  articles?: BlowfishRecentArticle[];
  contentHtml?: string;
}

const { config, articles = [], contentHtml = '' } = Astro.props;
const backgroundImage = config.backgroundImage || config.homepageImage || config.image || '';
const backgroundVideo = config.backgroundVideo?.trim() || '';
const hasBackgroundVideo = backgroundVideo.length > 0;
const avatar = config.image || config.homepageImage;
const enableBlur = (config.layoutBackgroundBlur ?? false) && !hasBackgroundVideo;
---

<article class="max-w-full prose dark:prose-invert">
  <div class="relative">
    <div class="absolute inset-x-0 bottom-0 h-1/2"></div>
    <div class="mx-auto max-w-7xl p-0">
      <div class="relative sm:overflow-hidden">
        <div class="fixed inset-x-0 top-0 -z-10">
          {hasBackgroundVideo ? (
            <>
              {backgroundImage && (
                <img
                  id="background-image"
                  data-bf-home-background-poster
                  class="absolute inset-0 nozoom mt-0 mr-0 mb-0 ml-0 h-[1000px] w-full object-cover transition-opacity duration-500"
                  src={backgroundImage}
                  alt=""
                  role="presentation"
                />
              )}
              <video
                data-bf-home-background-video
                class="absolute inset-0 nozoom mt-0 mr-0 mb-0 ml-0 h-[1000px] w-full object-cover opacity-0 transition-opacity duration-500"
                autoplay
                loop
                muted
                playsinline
                preload="metadata"
                poster={backgroundImage || undefined}
                aria-hidden="true"
              >
                <source src={backgroundVideo} type="video/webm" />
              </video>
              <script is:inline>
                (() => {
                  document.querySelectorAll('video[data-bf-home-background-video]').forEach((video) => {
                    if (video.dataset.bfInitialized === 'true') return;
                    video.dataset.bfInitialized = 'true';

                    const container = video.parentElement;
                    const poster = container?.querySelector('[data-bf-home-background-poster]');
                    const revealVideo = () => {
                      Promise.resolve(video.play?.())
                        .catch(() => undefined)
                        .finally(() => {
                          video.classList.remove('opacity-0');
                          video.classList.add('opacity-100');
                          if (poster) {
                            poster.classList.add('opacity-0');
                            poster.addEventListener('transitionend', () => poster.remove(), { once: true });
                          }
                        });
                    };

                    video.addEventListener('canplay', revealVideo, { once: true });
                    video.addEventListener('loadeddata', revealVideo, { once: true });

                    if (video.readyState >= 2) {
                      revealVideo();
                    }
                  });
                })();
              </script>
            </>
          ) : (
            backgroundImage && <img id="background-image" class="nozoom mt-0 mr-0 mb-0 ml-0 h-[1000px] w-full object-cover" src={backgroundImage} role="presentation" />
          )}
          {!hasBackgroundVideo && (
            <>
              <div class="from-neutral absolute inset-0 h-[1000px] bg-gradient-to-t to-transparent mix-blend-normal dark:from-neutral-800"></div>
              <div class="from-neutral absolute inset-0 h-[1000px] bg-gradient-to-t to-neutral-100 opacity-60 mix-blend-normal dark:from-neutral-800 dark:to-neutral-800"></div>
            </>
          )}
        </div>
        <div class="relative flex flex-col items-center justify-center px-1 py-1 text-center">
          {avatar && (
            <img
              class="mb-2 h-36 w-36 rounded-full"
              width="144"
              height="144"
              src={avatar}
              alt={config.imageAlt || config.title || t('components.author_image_alt')}
              data-zoom-src={avatar}
            />
          )}
          <h1 class="mb-2 text-4xl font-extrabold text-neutral-800 dark:text-neutral-200">{config.title || t('author.default_name')}</h1>
          {config.subtitle && <h2 class="mb-0 mt-0 text-xl text-neutral-800 dark:text-neutral-300">{config.subtitle}</h2>}
          {config.links && config.links.length > 0 && (
            <div class="mt-3 mb-10 flex flex-wrap text-2xl">
              {config.links.map((link) => (
                <a class="px-1 text-primary-800 hover:text-primary-400 dark:text-primary-200" href={link.href} target="_blank" rel="me noopener noreferrer" aria-label={link.label} title={link.label}>
                  {link.label}
                </a>
              ))}
            </div>
          )}
          <section class="prose w-full dark:prose-invert">
            {contentHtml ? <div set:html={contentHtml} /> : config.description ? <p>{config.description}</p> : <slot />}
          </section>
        </div>
      </div>
    </div>
  </div>
</article>

{config.showRecent && (
  <BlowfishHomeRecent
    articles={articles}
    limit={config.recentLimit || 4}
    cardView={Boolean(config.cardView)}
    showMoreLink={config.showMoreLink}
    heading={t('shortcode.recent_articles')}
  />
)}

{enableBlur && (
  <>
    <div
      id="background-blur"
      class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-xl bg-neutral-100/75 dark:bg-neutral-800/60"
    ></div>
    <script is:inline data-blur-id="background-blur" data-image-id="background-image"></script>
  </>
)}
