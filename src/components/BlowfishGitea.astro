---
import BlowfishRepoCard from './BlowfishRepoCard.astro';
import { pickString } from '../lib/props';
import { fetchJsonSafe } from '../lib/remote';

interface GiteaResponse {
  full_name?: string;
  html_url?: string;
  description?: string | null;
  language?: string | null;
  stars_count?: number;
  forks_count?: number;
}

export interface Props {
  repo?: string;
  repository?: string;
  owner?: string;
  user?: string;
  host?: string;
}

const props = Astro.props as Record<string, unknown>;
const repo = pickString(props, ['repo', 'repository']);
const owner = pickString(props, ['owner', 'user']);
const host = pickString(props, ['host'], 'gitea.com');
const path = owner ? `${owner}/${repo}` : repo;

const fallbackHref = `https://${host}/${path}`;
const apiUrl = `https://${host}/api/v1/repos/${path}`;
const data = path ? await fetchJsonSafe<GiteaResponse>(apiUrl) : null;
---

<BlowfishRepoCard
  href={data?.html_url || fallbackHref}
  icon="gitea"
  title="Gitea"
  fullName={data?.full_name || path || 'Gitea'}
  description={data?.description || undefined}
  language={data?.language || undefined}
  stars={typeof data?.stars_count === 'number' ? data.stars_count : undefined}
  forks={typeof data?.forks_count === 'number' ? data.forks_count : undefined}
/>
