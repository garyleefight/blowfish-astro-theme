---
import { t } from '../../lib/i18n';

interface TocItem {
  id: string;
  label: string;
  depth?: number;
}

export interface Props {
  items?: TocItem[];
}

const { items = [] } = Astro.props;

const listClasses = 'm-0 list-decimal ps-5 text-sm leading-6';
const linkClasses = 'font-normal text-neutral-700 dark:text-neutral-300 no-underline hover:text-primary-600 dark:hover:text-primary-400';

function escapeHtml(value: string) {
  return value
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

const boundedDepths = items.map((item) => Math.min(Math.max(item.depth ?? 1, 1), 6));
const minDepth = boundedDepths.length > 0 ? Math.min(...boundedDepths) : 1;
const normalizedItems = items.map((item) => ({
  id: item.id,
  label: item.label,
  depth: Math.min(Math.max((item.depth ?? minDepth) - minDepth + 1, 1), 6),
}));

function buildTocHtml(entries: Array<{ id: string; label: string; depth: number }>) {
  if (entries.length === 0) return '';

  let html = `<ol class="${listClasses}">`;
  let currentDepth = 1;

  for (let index = 0; index < entries.length; index += 1) {
    const item = entries[index];
    let targetDepth = item.depth;

    if (index === 0) {
      targetDepth = 1;
    } else {
      targetDepth = Math.min(targetDepth, currentDepth + 1);
    }

    if (index > 0) {
      if (targetDepth > currentDepth) {
        html += `<ol class="${listClasses}">`;
      } else if (targetDepth < currentDepth) {
        while (currentDepth > targetDepth) {
          html += '</li></ol>';
          currentDepth -= 1;
        }
        html += '</li>';
      } else {
        html += '</li>';
      }
    }

    const safeId = escapeHtml(item.id);
    const safeLabel = escapeHtml(item.label);
    html += `<li><a class="${linkClasses}" href="#${safeId}">${safeLabel}</a>`;
    currentDepth = targetDepth;
  }

  while (currentDepth > 1) {
    html += '</li></ol>';
    currentDepth -= 1;
  }

  html += '</li></ol>';
  return html;
}

const tocHtml = buildTocHtml(normalizedItems);
---

{normalizedItems.length > 0 && (
  <>
    <details open id="TOCView" class="toc-right mt-0 overflow-y-auto overscroll-contain bf-scrollbar rounded-lg -ms-5 ps-5 pe-2 hidden lg:block">
      <summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
        {t('article.table_of_contents')}
      </summary>
      <div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600" set:html={tocHtml} />
    </details>

    <details class="toc-inside mt-0 overflow-hidden rounded-lg -ms-5 ps-5 lg:hidden">
      <summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 -ms-5 ps-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
        {t('article.table_of_contents')}
      </summary>
      <div class="py-2 border-dotted border-neutral-300 border-s-1 -ms-5 ps-5 dark:border-neutral-600" set:html={tocHtml} />
    </details>
  </>
)}
