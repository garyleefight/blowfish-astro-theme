---
import BlowfishSiteLayout from '../layouts/site/BlowfishSiteLayout.astro';
---

<BlowfishSiteLayout
  title="Search"
  description="Search across site content"
  nav={[{ label: 'Home', href: '/' }, { label: 'Theme List', href: '/theme/list' }]}
>
  <section class="bf-card bf-search-page">
    <h1>Search</h1>
    <p class="bf-muted">Search template parity with Fuse.js client-side index.</p>

    <form id="bf-search-form">
      <input id="bf-search-input" type="search" placeholder="Search posts..." autocomplete="off" />
    </form>

    <div id="bf-search-results" class="bf-search-results" aria-live="polite"></div>
  </section>

  <script is:inline src="/blowfish-lib/fuse/fuse.min.js"></script>
  <script is:inline>
    const input = document.getElementById('bf-search-input');
    const results = document.getElementById('bf-search-results');

    const render = (items) => {
      if (!results) return;
      if (!items.length) {
        results.innerHTML = '<p class="bf-muted">No results.</p>';
        return;
      }
      results.innerHTML = items
        .map((item) => {
          const d = item.date ? `<p class="bf-muted">${item.date}</p>` : '';
          const s = item.summary ? `<p>${item.summary}</p>` : '';
          return `<article class="bf-card bf-search-item"><h2><a href="${item.href}">${item.title}</a></h2>${d}${s}</article>`;
        })
        .join('');
    };

    const boot = async () => {
      const response = await fetch('/search-index.json');
      const data = await response.json();
      const fuse = new Fuse(data, {
        keys: ['title', 'summary', 'tags'],
        threshold: 0.35,
        includeScore: true
      });

      render(data);

      input?.addEventListener('input', (event) => {
        const value = event.target?.value?.trim?.() || '';
        if (!value) {
          render(data);
          return;
        }
        const matches = fuse.search(value).map((m) => m.item);
        render(matches);
      });
    };

    boot();
  </script>
</BlowfishSiteLayout>

<style>
  .bf-search-page { padding: 1rem; }
  .bf-search-page h1 { margin: 0; }
  .bf-search-page form { margin-top: 0.8rem; }
  .bf-search-page input {
    width: min(100%, 500px);
    border: 1px solid var(--bf-border);
    border-radius: 0.5rem;
    padding: 0.5rem 0.65rem;
    color: var(--bf-text);
    background: color-mix(in srgb, var(--bf-surface) 84%, black 16%);
  }
  .bf-search-results { margin-top: 1rem; display: grid; gap: 0.8rem; }
  .bf-search-item { padding: 0.8rem 0.9rem; }
  .bf-search-item h2 { margin: 0; font-size: 1.05rem; }
  .bf-search-item h2 a { color: var(--bf-text); text-decoration: none; }
  .bf-search-item p { margin: 0.45rem 0 0; }
</style>
